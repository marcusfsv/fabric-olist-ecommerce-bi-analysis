{"$schema":"http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#","contentVersion":"1.0.0.0","parameters":{"Olist_BronzeSilver_Lakehouse":{"type":"string"},"Olist_Gold_Warehouse":{"type":"string"}},"variables":{},"resources":[{"name":"Olist_SilverToGold_DataTransformation","type":"pipelines","apiVersion":"2018-06-01","properties":{"description":"Manual","activities":[{"name":"Copy_olist_silver_customers","type":"Copy","dependsOn":[{"activity":"Script_01_setup_schemas","dependencyConditions":["Succeeded"]}],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"typeProperties":{"source":{"type":"LakehouseTableSource","datasetSettings":{"annotations":[],"linkedService":{"name":"Olist_BronzeSilver_Lakehouse","properties":{"annotations":[],"type":"Lakehouse","typeProperties":{"workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47","artifactId":"[parameters('Olist_BronzeSilver_Lakehouse')]","rootFolder":"Tables"}}},"type":"LakehouseTable","schema":[],"typeProperties":{"table":"olist_silver_customers"}}},"sink":{"type":"DataWarehouseSink","allowCopyCommand":true,"copyCommandSettings":{},"tableOption":"autoCreate","datasetSettings":{"annotations":[],"linkedService":{"name":"Olist_Gold_Warehouse","properties":{"annotations":[],"type":"DataWarehouse","typeProperties":{"endpoint":"syksq5mooojuplq6qvrqwqropy-w4eyqycrmwautdb4wfp7eti4i4.datawarehouse.fabric.microsoft.com","artifactId":"[parameters('Olist_Gold_Warehouse')]","workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47"}}},"type":"DataWarehouseTable","schema":[],"typeProperties":{"schema":"stg","table":"stg_customers"}}},"enableStaging":true,"translator":{"type":"TabularTranslator","mappings":[{"source":{"name":"customer_id","type":"String","physicalType":"string"},"sink":{"name":"customer_id","physicalType":"varchar","length":"8000"}},{"source":{"name":"customer_unique_id","type":"String","physicalType":"string"},"sink":{"name":"customer_unique_id","physicalType":"varchar","length":"8000"}},{"source":{"name":"customer_zip_code_prefix","type":"Int32","physicalType":"integer"},"sink":{"name":"customer_zip_code_prefix","physicalType":"int"}},{"source":{"name":"customer_city","type":"String","physicalType":"string"},"sink":{"name":"customer_city","physicalType":"varchar","length":"8000"}},{"source":{"name":"customer_state","type":"String","physicalType":"string"},"sink":{"name":"customer_state","physicalType":"varchar","length":"8000"}}],"typeConversion":true,"typeConversionSettings":{"allowDataTruncation":true,"treatBooleanAsNumber":false}}}},{"name":"Copy_olist_silver_geolocation","type":"Copy","dependsOn":[{"activity":"Script_01_setup_schemas","dependencyConditions":["Succeeded"]}],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"typeProperties":{"source":{"type":"LakehouseTableSource","datasetSettings":{"annotations":[],"linkedService":{"name":"Olist_BronzeSilver_Lakehouse","properties":{"annotations":[],"type":"Lakehouse","typeProperties":{"workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47","artifactId":"[parameters('Olist_BronzeSilver_Lakehouse')]","rootFolder":"Tables"}}},"type":"LakehouseTable","schema":[],"typeProperties":{"table":"olist_silver_geolocation"}}},"sink":{"type":"DataWarehouseSink","allowCopyCommand":true,"copyCommandSettings":{},"tableOption":"autoCreate","datasetSettings":{"annotations":[],"linkedService":{"name":"Olist_Gold_Warehouse","properties":{"annotations":[],"type":"DataWarehouse","typeProperties":{"endpoint":"syksq5mooojuplq6qvrqwqropy-w4eyqycrmwautdb4wfp7eti4i4.datawarehouse.fabric.microsoft.com","artifactId":"[parameters('Olist_Gold_Warehouse')]","workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47"}}},"type":"DataWarehouseTable","schema":[],"typeProperties":{"schema":"stg","table":"stg_geolocation"}}},"enableStaging":true,"translator":{"type":"TabularTranslator","mappings":[{"source":{"name":"geolocation_zip_code_prefix","type":"Int32","physicalType":"integer"},"sink":{"name":"geolocation_zip_code_prefix","physicalType":"int"}},{"source":{"name":"geolocation_lat","type":"Double","physicalType":"double"},"sink":{"name":"geolocation_lat","physicalType":"float"}},{"source":{"name":"geolocation_lng","type":"Double","physicalType":"double"},"sink":{"name":"geolocation_lng","physicalType":"float"}},{"source":{"name":"geolocation_city_raw","type":"String","physicalType":"string"},"sink":{"name":"geolocation_city_raw","physicalType":"varchar","length":"8000"}},{"source":{"name":"geolocation_state","type":"String","physicalType":"string"},"sink":{"name":"geolocation_state","physicalType":"varchar","length":"8000"}},{"source":{"name":"geolocation_city","type":"String","physicalType":"string"},"sink":{"name":"geolocation_city","physicalType":"varchar","length":"8000"}},{"source":{"name":"flag_nonalpha_city","type":"Boolean","physicalType":"boolean"},"sink":{"name":"flag_nonalpha_city","physicalType":"bit"}}],"typeConversion":true,"typeConversionSettings":{"allowDataTruncation":true,"treatBooleanAsNumber":false}}}},{"name":"Copy_olist_silver_orderitems","type":"Copy","dependsOn":[{"activity":"Script_01_setup_schemas","dependencyConditions":["Succeeded"]}],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"typeProperties":{"source":{"type":"LakehouseTableSource","datasetSettings":{"annotations":[],"linkedService":{"name":"Olist_BronzeSilver_Lakehouse","properties":{"annotations":[],"type":"Lakehouse","typeProperties":{"workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47","artifactId":"[parameters('Olist_BronzeSilver_Lakehouse')]","rootFolder":"Tables"}}},"type":"LakehouseTable","schema":[],"typeProperties":{"table":"olist_silver_orderitems"}}},"sink":{"type":"DataWarehouseSink","allowCopyCommand":true,"copyCommandSettings":{},"tableOption":"autoCreate","datasetSettings":{"annotations":[],"linkedService":{"name":"Olist_Gold_Warehouse","properties":{"annotations":[],"type":"DataWarehouse","typeProperties":{"endpoint":"syksq5mooojuplq6qvrqwqropy-w4eyqycrmwautdb4wfp7eti4i4.datawarehouse.fabric.microsoft.com","artifactId":"[parameters('Olist_Gold_Warehouse')]","workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47"}}},"type":"DataWarehouseTable","schema":[],"typeProperties":{"schema":"stg","table":"stg_order_items"}}},"enableStaging":true,"translator":{"type":"TabularTranslator","mappings":[{"source":{"name":"order_id","type":"String","physicalType":"string"},"sink":{"name":"order_id","physicalType":"varchar","length":"8000"}},{"source":{"name":"order_item_id","type":"Int32","physicalType":"integer"},"sink":{"name":"order_item_id","physicalType":"int"}},{"source":{"name":"product_id","type":"String","physicalType":"string"},"sink":{"name":"product_id","physicalType":"varchar","length":"8000"}},{"source":{"name":"seller_id","type":"String","physicalType":"string"},"sink":{"name":"seller_id","physicalType":"varchar","length":"8000"}},{"source":{"name":"shipping_limit_date","type":"DateTime","physicalType":"timestamp"},"sink":{"name":"shipping_limit_date","physicalType":"datetime2","precision":6}},{"source":{"name":"price","type":"Decimal","physicalType":"decimal","scale":2,"precision":10},"sink":{"name":"price","physicalType":"decimal","scale":2,"precision":10}},{"source":{"name":"freight_value","type":"Decimal","physicalType":"decimal","scale":2,"precision":10},"sink":{"name":"freight_value","physicalType":"decimal","scale":2,"precision":10}}],"typeConversion":true,"typeConversionSettings":{"allowDataTruncation":true,"treatBooleanAsNumber":false}}}},{"name":"Copy_olist_silver_orderpayments","type":"Copy","dependsOn":[{"activity":"Script_01_setup_schemas","dependencyConditions":["Succeeded"]}],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"typeProperties":{"source":{"type":"LakehouseTableSource","datasetSettings":{"annotations":[],"linkedService":{"name":"Olist_BronzeSilver_Lakehouse","properties":{"annotations":[],"type":"Lakehouse","typeProperties":{"workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47","artifactId":"[parameters('Olist_BronzeSilver_Lakehouse')]","rootFolder":"Tables"}}},"type":"LakehouseTable","schema":[],"typeProperties":{"table":"olist_silver_orderpayments"}}},"sink":{"type":"DataWarehouseSink","allowCopyCommand":true,"copyCommandSettings":{},"tableOption":"autoCreate","datasetSettings":{"annotations":[],"linkedService":{"name":"Olist_Gold_Warehouse","properties":{"annotations":[],"type":"DataWarehouse","typeProperties":{"endpoint":"syksq5mooojuplq6qvrqwqropy-w4eyqycrmwautdb4wfp7eti4i4.datawarehouse.fabric.microsoft.com","artifactId":"[parameters('Olist_Gold_Warehouse')]","workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47"}}},"type":"DataWarehouseTable","schema":[],"typeProperties":{"schema":"stg","table":"stg_order_payments"}}},"enableStaging":true,"translator":{"type":"TabularTranslator","mappings":[{"source":{"name":"order_id","type":"String","physicalType":"string"},"sink":{"name":"order_id","physicalType":"varchar","length":"8000"}},{"source":{"name":"payment_sequential","type":"Int32","physicalType":"integer"},"sink":{"name":"payment_sequential","physicalType":"int"}},{"source":{"name":"payment_type","type":"String","physicalType":"string"},"sink":{"name":"payment_type","physicalType":"varchar","length":"8000"}},{"source":{"name":"payment_installments","type":"Int32","physicalType":"integer"},"sink":{"name":"payment_installments","physicalType":"int"}},{"source":{"name":"payment_value","type":"Decimal","physicalType":"decimal","scale":2,"precision":10},"sink":{"name":"payment_value","physicalType":"decimal","scale":2,"precision":10}}],"typeConversion":true,"typeConversionSettings":{"allowDataTruncation":true,"treatBooleanAsNumber":false}}}},{"name":"Copy_olist_silver_orderreviews","type":"Copy","dependsOn":[{"activity":"Script_01_setup_schemas","dependencyConditions":["Succeeded"]}],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"typeProperties":{"source":{"type":"LakehouseTableSource","datasetSettings":{"annotations":[],"linkedService":{"name":"Olist_BronzeSilver_Lakehouse","properties":{"annotations":[],"type":"Lakehouse","typeProperties":{"workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47","artifactId":"[parameters('Olist_BronzeSilver_Lakehouse')]","rootFolder":"Tables"}}},"type":"LakehouseTable","schema":[],"typeProperties":{"table":"olist_silver_orderreviews"}}},"sink":{"type":"DataWarehouseSink","allowCopyCommand":true,"copyCommandSettings":{},"tableOption":"autoCreate","datasetSettings":{"annotations":[],"linkedService":{"name":"Olist_Gold_Warehouse","properties":{"annotations":[],"type":"DataWarehouse","typeProperties":{"endpoint":"syksq5mooojuplq6qvrqwqropy-w4eyqycrmwautdb4wfp7eti4i4.datawarehouse.fabric.microsoft.com","artifactId":"[parameters('Olist_Gold_Warehouse')]","workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47"}}},"type":"DataWarehouseTable","schema":[],"typeProperties":{"schema":"stg","table":"stg_order_reviews"}}},"enableStaging":true,"translator":{"type":"TabularTranslator","mappings":[{"source":{"name":"review_id","type":"String","physicalType":"string"},"sink":{"name":"review_id","physicalType":"varchar","length":"8000"}},{"source":{"name":"order_id","type":"String","physicalType":"string"},"sink":{"name":"order_id","physicalType":"varchar","length":"8000"}},{"source":{"name":"review_score","type":"Int32","physicalType":"integer"},"sink":{"name":"review_score","physicalType":"int"}},{"source":{"name":"review_comment_title","type":"String","physicalType":"string"},"sink":{"name":"review_comment_title","physicalType":"varchar","length":"8000"}},{"source":{"name":"review_comment_message","type":"String","physicalType":"string"},"sink":{"name":"review_comment_message","physicalType":"varchar","length":"8000"}},{"source":{"name":"review_creation_date","type":"DateTime","physicalType":"timestamp"},"sink":{"name":"review_creation_date","physicalType":"datetime2","precision":6}},{"source":{"name":"review_answer_timestamp","type":"DateTime","physicalType":"timestamp"},"sink":{"name":"review_answer_timestamp","physicalType":"datetime2","precision":6}},{"source":{"name":"flag_missing_value","type":"Boolean","physicalType":"boolean"},"sink":{"name":"flag_missing_value","physicalType":"bit"}},{"source":{"name":"flag_note_review_info","type":"String","physicalType":"string"},"sink":{"name":"flag_note_review_info","physicalType":"varchar","length":"8000"}}],"typeConversion":true,"typeConversionSettings":{"allowDataTruncation":true,"treatBooleanAsNumber":false}}}},{"name":"Copy_olist_silver_orders","type":"Copy","dependsOn":[{"activity":"Script_01_setup_schemas","dependencyConditions":["Succeeded"]}],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"typeProperties":{"source":{"type":"LakehouseTableSource","datasetSettings":{"annotations":[],"linkedService":{"name":"Olist_BronzeSilver_Lakehouse","properties":{"annotations":[],"type":"Lakehouse","typeProperties":{"workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47","artifactId":"[parameters('Olist_BronzeSilver_Lakehouse')]","rootFolder":"Tables"}}},"type":"LakehouseTable","schema":[],"typeProperties":{"table":"olist_silver_orders"}}},"sink":{"type":"DataWarehouseSink","allowCopyCommand":true,"copyCommandSettings":{},"tableOption":"autoCreate","datasetSettings":{"annotations":[],"linkedService":{"name":"Olist_Gold_Warehouse","properties":{"annotations":[],"type":"DataWarehouse","typeProperties":{"endpoint":"syksq5mooojuplq6qvrqwqropy-w4eyqycrmwautdb4wfp7eti4i4.datawarehouse.fabric.microsoft.com","artifactId":"[parameters('Olist_Gold_Warehouse')]","workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47"}}},"type":"DataWarehouseTable","schema":[],"typeProperties":{"schema":"stg","table":"stg_orders"}}},"enableStaging":true,"translator":{"type":"TabularTranslator","mappings":[{"source":{"name":"order_id","type":"String","physicalType":"string"},"sink":{"name":"order_id","physicalType":"varchar","length":"8000"}},{"source":{"name":"customer_id","type":"String","physicalType":"string"},"sink":{"name":"customer_id","physicalType":"varchar","length":"8000"}},{"source":{"name":"order_status","type":"String","physicalType":"string"},"sink":{"name":"order_status","physicalType":"varchar","length":"8000"}},{"source":{"name":"order_purchase_timestamp","type":"DateTime","physicalType":"timestamp"},"sink":{"name":"order_purchase_timestamp","physicalType":"datetime2","precision":6}},{"source":{"name":"order_approved_at","type":"DateTime","physicalType":"timestamp"},"sink":{"name":"order_approved_at","physicalType":"datetime2","precision":6}},{"source":{"name":"order_delivered_carrier_date","type":"DateTime","physicalType":"timestamp"},"sink":{"name":"order_delivered_carrier_date","physicalType":"datetime2","precision":6}},{"source":{"name":"order_delivered_customer_date","type":"DateTime","physicalType":"timestamp"},"sink":{"name":"order_delivered_customer_date","physicalType":"datetime2","precision":6}},{"source":{"name":"order_estimated_delivery_date","type":"DateTime","physicalType":"timestamp"},"sink":{"name":"order_estimated_delivery_date","physicalType":"datetime2","precision":6}},{"source":{"name":"flag_missing_value","type":"Boolean","physicalType":"boolean"},"sink":{"name":"flag_missing_value","physicalType":"bit"}},{"source":{"name":"flag_note_order_approved_at","type":"String","physicalType":"string"},"sink":{"name":"flag_note_order_approved_at","physicalType":"varchar","length":"8000"}},{"source":{"name":"flag_note_order_delivered_carrier_date","type":"String","physicalType":"string"},"sink":{"name":"flag_note_order_delivered_carrier_date","physicalType":"varchar","length":"8000"}},{"source":{"name":"flag_note_order_delivered_customer_date","type":"String","physicalType":"string"},"sink":{"name":"flag_note_order_delivered_customer_date","physicalType":"varchar","length":"8000"}},{"source":{"name":"flag_carrier_before_approval","type":"Boolean","physicalType":"boolean"},"sink":{"name":"flag_carrier_before_approval","physicalType":"bit"}},{"source":{"name":"flag_customer_before_carrier","type":"Boolean","physicalType":"boolean"},"sink":{"name":"flag_customer_before_carrier","physicalType":"bit"}}],"typeConversion":true,"typeConversionSettings":{"allowDataTruncation":true,"treatBooleanAsNumber":false}}}},{"name":"Copy_olist_silver_products","type":"Copy","dependsOn":[{"activity":"Script_01_setup_schemas","dependencyConditions":["Succeeded"]}],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"typeProperties":{"source":{"type":"LakehouseTableSource","datasetSettings":{"annotations":[],"linkedService":{"name":"Olist_BronzeSilver_Lakehouse","properties":{"annotations":[],"type":"Lakehouse","typeProperties":{"workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47","artifactId":"[parameters('Olist_BronzeSilver_Lakehouse')]","rootFolder":"Tables"}}},"type":"LakehouseTable","schema":[],"typeProperties":{"table":"olist_silver_products"}}},"sink":{"type":"DataWarehouseSink","allowCopyCommand":true,"copyCommandSettings":{},"tableOption":"autoCreate","datasetSettings":{"annotations":[],"linkedService":{"name":"Olist_Gold_Warehouse","properties":{"annotations":[],"type":"DataWarehouse","typeProperties":{"endpoint":"syksq5mooojuplq6qvrqwqropy-w4eyqycrmwautdb4wfp7eti4i4.datawarehouse.fabric.microsoft.com","artifactId":"[parameters('Olist_Gold_Warehouse')]","workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47"}}},"type":"DataWarehouseTable","schema":[],"typeProperties":{"schema":"stg","table":"stg_products"}}},"enableStaging":true,"translator":{"type":"TabularTranslator","mappings":[{"source":{"name":"product_id","type":"String","physicalType":"string"},"sink":{"name":"product_id","physicalType":"varchar","length":"8000"}},{"source":{"name":"product_category_name_raw","type":"String","physicalType":"string"},"sink":{"name":"product_category_name_raw","physicalType":"varchar","length":"8000"}},{"source":{"name":"product_category_name","type":"String","physicalType":"string"},"sink":{"name":"product_category_name","physicalType":"varchar","length":"8000"}},{"source":{"name":"product_name_lenght","type":"Int32","physicalType":"integer"},"sink":{"name":"product_name_lenght","physicalType":"int"}},{"source":{"name":"product_description_lenght","type":"Int32","physicalType":"integer"},"sink":{"name":"product_description_lenght","physicalType":"int"}},{"source":{"name":"product_photos_qty","type":"Int32","physicalType":"integer"},"sink":{"name":"product_photos_qty","physicalType":"int"}},{"source":{"name":"product_weight_g","type":"Int32","physicalType":"integer"},"sink":{"name":"product_weight_g","physicalType":"int"}},{"source":{"name":"product_length_cm","type":"Int32","physicalType":"integer"},"sink":{"name":"product_length_cm","physicalType":"int"}},{"source":{"name":"product_height_cm","type":"Int32","physicalType":"integer"},"sink":{"name":"product_height_cm","physicalType":"int"}},{"source":{"name":"product_width_cm","type":"Int32","physicalType":"integer"},"sink":{"name":"product_width_cm","physicalType":"int"}},{"source":{"name":"flag_missing_product_info","type":"Boolean","physicalType":"boolean"},"sink":{"name":"flag_missing_product_info","physicalType":"bit"}},{"source":{"name":"flag_note_product_info","type":"String","physicalType":"string"},"sink":{"name":"flag_note_product_info","physicalType":"varchar","length":"8000"}}],"typeConversion":true,"typeConversionSettings":{"allowDataTruncation":true,"treatBooleanAsNumber":false}}}},{"name":"Copy_olist_silver_sellers","type":"Copy","dependsOn":[{"activity":"Script_01_setup_schemas","dependencyConditions":["Succeeded"]}],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"typeProperties":{"source":{"type":"LakehouseTableSource","datasetSettings":{"annotations":[],"linkedService":{"name":"Olist_BronzeSilver_Lakehouse","properties":{"annotations":[],"type":"Lakehouse","typeProperties":{"workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47","artifactId":"[parameters('Olist_BronzeSilver_Lakehouse')]","rootFolder":"Tables"}}},"type":"LakehouseTable","schema":[],"typeProperties":{"table":"olist_silver_sellers"}}},"sink":{"type":"DataWarehouseSink","allowCopyCommand":true,"copyCommandSettings":{},"tableOption":"autoCreate","datasetSettings":{"annotations":[],"linkedService":{"name":"Olist_Gold_Warehouse","properties":{"annotations":[],"type":"DataWarehouse","typeProperties":{"endpoint":"syksq5mooojuplq6qvrqwqropy-w4eyqycrmwautdb4wfp7eti4i4.datawarehouse.fabric.microsoft.com","artifactId":"[parameters('Olist_Gold_Warehouse')]","workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47"}}},"type":"DataWarehouseTable","schema":[],"typeProperties":{"schema":"stg","table":"stg_sellers"}}},"enableStaging":true,"translator":{"type":"TabularTranslator","mappings":[{"source":{"name":"seller_id","type":"String","physicalType":"string"},"sink":{"name":"seller_id","physicalType":"varchar","length":"8000"}},{"source":{"name":"seller_zip_code_prefix","type":"Int32","physicalType":"integer"},"sink":{"name":"seller_zip_code_prefix","physicalType":"int"}},{"source":{"name":"seller_city","type":"String","physicalType":"string"},"sink":{"name":"seller_city","physicalType":"varchar","length":"8000"}},{"source":{"name":"seller_state","type":"String","physicalType":"string"},"sink":{"name":"seller_state","physicalType":"varchar","length":"8000"}}],"typeConversion":true,"typeConversionSettings":{"allowDataTruncation":true,"treatBooleanAsNumber":false}}}},{"name":"Script_01_setup_schemas","type":"Script","dependsOn":[],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"linkedService":{"name":"Olist_Gold_Warehouse","properties":{"annotations":[],"type":"DataWarehouse","typeProperties":{"endpoint":"syksq5mooojuplq6qvrqwqropy-w4eyqycrmwautdb4wfp7eti4i4.datawarehouse.fabric.microsoft.com","artifactId":"[parameters('Olist_Gold_Warehouse')]","workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47"}}},"typeProperties":{"scripts":[{"type":"Query","text":{"value":"-- Create the necessary schemas \n\nIF NOT EXISTS (SELECT 1 FROM sys.schemas WHERE name = 'stg')  EXEC('CREATE SCHEMA stg;');\nIF NOT EXISTS (SELECT 1 FROM sys.schemas WHERE name = 'dim')  EXEC('CREATE SCHEMA dim;');\nIF NOT EXISTS (SELECT 1 FROM sys.schemas WHERE name = 'fact') EXEC('CREATE SCHEMA fact;');","type":"Expression"}}],"scriptBlockExecutionTimeout":"02:00:00"}},{"name":"Script_11_dim_geolocation","type":"Script","dependsOn":[{"activity":"Copy_olist_silver_customers","dependencyConditions":["Succeeded"]},{"activity":"Copy_olist_silver_geolocation","dependencyConditions":["Succeeded"]},{"activity":"Copy_olist_silver_sellers","dependencyConditions":["Succeeded"]}],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"linkedService":{"name":"Olist_Gold_Warehouse","properties":{"annotations":[],"type":"DataWarehouse","typeProperties":{"endpoint":"syksq5mooojuplq6qvrqwqropy-w4eyqycrmwautdb4wfp7eti4i4.datawarehouse.fabric.microsoft.com","artifactId":"[parameters('Olist_Gold_Warehouse')]","workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47"}}},"typeProperties":{"scripts":[{"type":"Query","text":{"value":"/* \nThe stg_geolocation table contains the flag flag_nonalpha_city. \nThe flagged city contain names with non-alphabetic characters, which might indicate a problem.\nGiven that this table has several latitudes and longitudes for each combination of zip code, city, and state,\nand that we won't add them to dim_geolocation, we can select distinct combinations of zip code and state, \nand select the most frequent city.\n*/\n-- Create a new dim_geolocation table\nDROP TABLE IF EXISTS dim.dim_geolocation;\nCREATE TABLE dim.dim_geolocation AS\n-- Aggregate counts per (zip, state, city)\nWITH city_counts AS (\n    SELECT\n        geolocation_zip_code_prefix AS zip,\n        geolocation_state AS state,\n        geolocation_city AS city,\n        COUNT(*) AS cnt\n    FROM stg.stg_geolocation\n    GROUP BY geolocation_zip_code_prefix, geolocation_state, geolocation_city\n),\n-- Rank cities by frequency desc\nranked AS (\n    SELECT\n        zip, state, city, cnt,\n        COUNT(*) OVER (PARTITION BY zip, state) AS city_variants,\n        ROW_NUMBER() OVER (PARTITION BY zip, state ORDER BY cnt DESC, city ASC) AS rnk\n    FROM city_counts\n)\n-- Keep only rnk = 1\nSELECT\n    ROW_NUMBER() OVER (ORDER BY zip, state) AS geo_sk,  -- surrogate key\n    zip AS geolocation_zip_code_prefix,\n    state AS geolocation_state,\n    city AS geolocation_city,\n    city_variants,\n    CASE WHEN city_variants > 1 THEN 1 ELSE 0 END AS flag_city_conflict  -- when there were multiple city spellings for the same ZIP+state\nFROM ranked\nWHERE rnk = 1;\n/* \nSome zip locations are present in the table customers/sellers but not in geolocation.\nWe can seed it with city from customers.\n-- Insert missing ZIP+state+city into dim_geolocation\nINSERT INTO dim.dim_geolocation (geolocation_zip_code_prefix, geolocation_city, geolocation_state)\nSELECT DISTINCT\n    c.customer_zip_code_prefix,\n    c.customer_city,\n    c.customer_state\nFROM stg.stg_customers c\nLEFT JOIN dim.dim_geolocation g\n       ON g.geolocation_zip_code_prefix = c.customer_zip_code_prefix\n      AND g.geolocation_state = c.customer_state\nWHERE g.geo_sk IS NULL;   -- only those not yet in dim_geolocation\n*/\n-- Create a list of needed (zip,state) not in dim_geolocation\nWITH want AS (\n    SELECT DISTINCT customer_zip_code_prefix AS zip, customer_state AS state\n    FROM stg.stg_customers\n    UNION\n    SELECT DISTINCT seller_zip_code_prefix, seller_state\n    FROM stg.stg_sellers\n),\nhave AS (\n    SELECT geolocation_zip_code_prefix AS zip, geolocation_state AS state\n    FROM dim.dim_geolocation\n),\nto_add AS (\n    SELECT w.zip, w.state\n    FROM want w\n    LEFT JOIN have h ON h.zip = w.zip AND h.state = w.state\n    WHERE h.zip IS NULL\n)\n-- Insert new rows with NULL city (or a best guess if you prefer)\nINSERT INTO dim.dim_geolocation\nSELECT\n    (SELECT COALESCE(MAX(geo_sk),0) FROM dim.dim_geolocation) + ROW_NUMBER() OVER (ORDER BY zip, state) AS geo_sk,\n    zip AS geolocation_zip_code_prefix,\n    state AS geolocation_state,\n    'unknown' AS geolocation_city,\n    0 AS city_variants,\n    0 AS flag_city_conflict\nFROM to_add;","type":"Expression"}}],"scriptBlockExecutionTimeout":"02:00:00"}},{"name":"Script_12_dim_customers","type":"Script","dependsOn":[{"activity":"Copy_olist_silver_customers","dependencyConditions":["Succeeded"]},{"activity":"Script_11_dim_geolocation","dependencyConditions":["Succeeded"]}],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"linkedService":{"name":"Olist_Gold_Warehouse","properties":{"annotations":[],"type":"DataWarehouse","typeProperties":{"endpoint":"syksq5mooojuplq6qvrqwqropy-w4eyqycrmwautdb4wfp7eti4i4.datawarehouse.fabric.microsoft.com","artifactId":"[parameters('Olist_Gold_Warehouse')]","workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47"}}},"typeProperties":{"scripts":[{"type":"Query","text":{"value":"-- Create a new dim_customers table\nDROP TABLE IF EXISTS dim.dim_customers;\n\nCREATE TABLE dim.dim_customers AS\nSELECT\n    ROW_NUMBER() OVER (ORDER BY customer_id) AS customer_sk,  -- surrogate key\n    c.customer_id,\n    c.customer_unique_id,\n    g.geo_sk  -- from dim_geolocation, joined on (zip,state)\nFROM (\n    SELECT DISTINCT\n        customer_id,\n        customer_unique_id,\n        customer_zip_code_prefix,\n        customer_state\n    FROM stg.stg_customers\n) c\nLEFT JOIN dim.dim_geolocation g\n    ON g.geolocation_zip_code_prefix = c.customer_zip_code_prefix\n    AND g.geolocation_state = c.customer_state;","type":"Expression"}}],"scriptBlockExecutionTimeout":"02:00:00"}},{"name":"Script_13_dim_sellers","type":"Script","dependsOn":[{"activity":"Copy_olist_silver_sellers","dependencyConditions":["Succeeded"]},{"activity":"Script_11_dim_geolocation","dependencyConditions":["Succeeded"]}],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"linkedService":{"name":"Olist_Gold_Warehouse","properties":{"annotations":[],"type":"DataWarehouse","typeProperties":{"endpoint":"syksq5mooojuplq6qvrqwqropy-w4eyqycrmwautdb4wfp7eti4i4.datawarehouse.fabric.microsoft.com","artifactId":"[parameters('Olist_Gold_Warehouse')]","workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47"}}},"typeProperties":{"scripts":[{"type":"Query","text":{"value":"-- Create a new dim_seller table\nDROP TABLE IF EXISTS dim.dim_sellers;\n\nCREATE TABLE dim.dim_sellers AS\nSELECT\n    ROW_NUMBER() OVER (ORDER BY seller_id) AS seller_sk,  -- surrogate key\n    s.seller_id,\n    g.geo_sk  -- from dim_geolocation, joined on (zip,state)\nFROM (\n    SELECT DISTINCT\n        seller_id,\n        seller_zip_code_prefix,\n        seller_state\n    FROM stg.stg_sellers\n) s\nLEFT JOIN dim.dim_geolocation g\n    ON g.geolocation_zip_code_prefix = s.seller_zip_code_prefix\n    AND g.geolocation_state = s.seller_state;","type":"Expression"}}],"scriptBlockExecutionTimeout":"02:00:00"}},{"name":"Script_14_dim_payment_type","type":"Script","dependsOn":[{"activity":"Copy_olist_silver_orderpayments","dependencyConditions":["Succeeded"]}],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"linkedService":{"name":"Olist_Gold_Warehouse","properties":{"annotations":[],"type":"DataWarehouse","typeProperties":{"endpoint":"syksq5mooojuplq6qvrqwqropy-w4eyqycrmwautdb4wfp7eti4i4.datawarehouse.fabric.microsoft.com","artifactId":"[parameters('Olist_Gold_Warehouse')]","workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47"}}},"typeProperties":{"scripts":[{"type":"Query","text":{"value":"-- Create a new dim_payment_type table\nDROP TABLE IF EXISTS dim.dim_payment_type;\n\nCREATE TABLE dim.dim_payment_type AS\nSELECT\n    DENSE_RANK() OVER (ORDER BY payment_type) AS payment_type_sk,  -- surrogate key\n    payment_type\nFROM (\n    SELECT DISTINCT payment_type\n    FROM stg.stg_order_payments\n) s;","type":"Expression"}}],"scriptBlockExecutionTimeout":"02:00:00"}},{"name":"Script_15_dim_products","type":"Script","dependsOn":[{"activity":"Copy_olist_silver_products","dependencyConditions":["Succeeded"]}],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"linkedService":{"name":"Olist_Gold_Warehouse","properties":{"annotations":[],"type":"DataWarehouse","typeProperties":{"endpoint":"syksq5mooojuplq6qvrqwqropy-w4eyqycrmwautdb4wfp7eti4i4.datawarehouse.fabric.microsoft.com","artifactId":"[parameters('Olist_Gold_Warehouse')]","workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47"}}},"typeProperties":{"scripts":[{"type":"Query","text":{"value":"/* \n\nThe stg_products table contains the flag flag_missing_product_info. \nIt indicates that there's at least one missing piece of product information. There are no problems with product_id.\nSince we are interested in the translated product_category_name, and the missing info was replaced with 'Unknown',\nwe can create proceed with creating the table dim_products.\n\n*/\n\n-- Create a new dim_products table\nDROP TABLE IF EXISTS dim.dim_products;\n\nCREATE TABLE dim.dim_products AS\nSELECT\n    DENSE_RANK() OVER (ORDER BY product_id) AS product_sk,  -- surrogate key\n    product_id,\n    product_category_name,\n    flag_missing_product_info\nFROM (\n    SELECT DISTINCT product_id, product_category_name, flag_missing_product_info\n    FROM stg.stg_products\n) p;","type":"Expression"}}],"scriptBlockExecutionTimeout":"02:00:00"}},{"name":"Script_16_dim_date","type":"Script","dependsOn":[{"activity":"Script_01_setup_schemas","dependencyConditions":["Succeeded"]},{"activity":"Copy_olist_silver_orders","dependencyConditions":["Succeeded"]}],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"linkedService":{"name":"Olist_Gold_Warehouse","properties":{"annotations":[],"type":"DataWarehouse","typeProperties":{"endpoint":"syksq5mooojuplq6qvrqwqropy-w4eyqycrmwautdb4wfp7eti4i4.datawarehouse.fabric.microsoft.com","artifactId":"[parameters('Olist_Gold_Warehouse')]","workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47"}}},"typeProperties":{"scripts":[{"type":"Query","text":{"value":"-- Create the table dim_date\nDROP TABLE IF EXISTS dim.dim_date;\n\nCREATE TABLE dim.dim_date AS\nWITH bounds AS (\n    SELECT CAST('2016-01-01' AS DATE) AS dmin,\n           CAST('2020-12-31' AS DATE) AS dmax\n),\nnums AS (  -- generate 0..N using your own rows (enough to cover the span)\n    SELECT ROW_NUMBER() OVER (ORDER BY (SELECT NULL)) - 1 AS n\n    FROM stg.stg_orders\n),\nseries AS (\n    SELECT DATEADD(DAY, n.n, b.dmin) AS [date]\n    FROM bounds b\n    JOIN nums   n\n      ON n.n <= DATEDIFF(DAY, b.dmin, b.dmax)\n)\nSELECT\n    ROW_NUMBER() OVER (ORDER BY [date]) AS date_sk,   -- surrogate key\n    [date],\n    YEAR([date]) AS [year],\n    DATEPART(QUARTER, [date]) AS [quarter],\n    MONTH([date]) AS [month],\n    CAST(DATENAME(MONTH, [date]) AS VARCHAR(20)) AS month_name,\n    DAY([date]) AS [day],\n    DATEPART(WEEKDAY, [date]) AS weekday_num,\n    CAST(DATENAME(WEEKDAY, [date]) AS VARCHAR(20)) AS weekday_name,\n    IIF(DATEPART(WEEKDAY, [date]) IN (1,7), 1, 0) AS is_weekend\nFROM series;","type":"Expression"}}],"scriptBlockExecutionTimeout":"02:00:00"}},{"name":"Script_21_fact_order_items","type":"Script","dependsOn":[{"activity":"Copy_olist_silver_orderitems","dependencyConditions":["Succeeded"]},{"activity":"Script_13_dim_sellers","dependencyConditions":["Succeeded"]},{"activity":"Script_15_dim_products","dependencyConditions":["Succeeded"]},{"activity":"Script_16_dim_date","dependencyConditions":["Succeeded"]}],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"linkedService":{"name":"Olist_Gold_Warehouse","properties":{"annotations":[],"type":"DataWarehouse","typeProperties":{"endpoint":"syksq5mooojuplq6qvrqwqropy-w4eyqycrmwautdb4wfp7eti4i4.datawarehouse.fabric.microsoft.com","artifactId":"[parameters('Olist_Gold_Warehouse')]","workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47"}}},"typeProperties":{"scripts":[{"type":"Query","text":{"value":"-- Creating fact_order_items\nDROP TABLE IF EXISTS fact.fact_order_items;\n\nCREATE TABLE fact.fact_order_items AS\nSELECT\n    CAST(oi.order_id AS VARCHAR(64)) AS order_id,  -- degenerate key\n    CAST(oi.order_item_id AS INT) AS order_item_id,  -- line sequence within the order\n    dp.product_sk,  -- FK to dim_products\n    ds.seller_sk,  -- FK to dim_sellers\n    dd.date_sk AS shipping_limit_date_sk,  -- FK to dim_date (by DATE)\n    CAST(oi.price AS DECIMAL(18,2)) AS price,\n    CAST(oi.freight_value AS DECIMAL(18,2)) AS freight_value,\n    CAST(1 AS INT) AS quantity,\n    (oi.price + oi.freight_value) AS line_total\nFROM stg.stg_order_items oi\nLEFT JOIN dim.dim_products dp\n    ON dp.product_id = oi.product_id\nLEFT JOIN dim.dim_sellers ds\n    ON ds.seller_id = oi.seller_id\nLEFT JOIN dim.dim_date dd\n    ON dd.[date] = CAST(oi.shipping_limit_date AS DATE);","type":"Expression"}}],"scriptBlockExecutionTimeout":"02:00:00"}},{"name":"Script_22_fact_order_payments","type":"Script","dependsOn":[{"activity":"Copy_olist_silver_orderpayments","dependencyConditions":["Succeeded"]},{"activity":"Script_14_dim_payment_type","dependencyConditions":["Succeeded"]}],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"linkedService":{"name":"Olist_Gold_Warehouse","properties":{"annotations":[],"type":"DataWarehouse","typeProperties":{"endpoint":"syksq5mooojuplq6qvrqwqropy-w4eyqycrmwautdb4wfp7eti4i4.datawarehouse.fabric.microsoft.com","artifactId":"[parameters('Olist_Gold_Warehouse')]","workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47"}}},"typeProperties":{"scripts":[{"type":"Query","text":{"value":"-- Creating fact_order_payments\nDROP TABLE IF EXISTS fact.fact_order_payments;\n\nCREATE TABLE fact.fact_order_payments AS\nSELECT\n    CAST(op.order_id AS VARCHAR(64)) AS order_id,  -- degenerate key\n    dpt.payment_type_sk,\n    op.payment_sequential,\n    op.payment_installments,\n    op.payment_value\nFROM stg.stg_order_payments op\nJOIN dim.dim_payment_type dpt\n    ON dpt.payment_type = op.payment_type;","type":"Expression"}}],"scriptBlockExecutionTimeout":"02:00:00"}},{"name":"Script_23_fact_order_reviews","type":"Script","dependsOn":[{"activity":"Copy_olist_silver_orderreviews","dependencyConditions":["Succeeded"]},{"activity":"Script_16_dim_date","dependencyConditions":["Succeeded"]}],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"linkedService":{"name":"Olist_Gold_Warehouse","properties":{"annotations":[],"type":"DataWarehouse","typeProperties":{"endpoint":"syksq5mooojuplq6qvrqwqropy-w4eyqycrmwautdb4wfp7eti4i4.datawarehouse.fabric.microsoft.com","artifactId":"[parameters('Olist_Gold_Warehouse')]","workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47"}}},"typeProperties":{"scripts":[{"type":"Query","text":{"value":"/*\n\nThe stg_order_reviews table contains the flag flag_missing_value. \nIt indicates that there's at least one review_comment_title or review_comment_message missing.\nHowever, we are more interested in the review_score, therefore we can proceed.\n\n*/\n\n-- Creating fact_order_reviews\nDROP TABLE IF EXISTS fact.fact_order_reviews;\n\nCREATE TABLE fact.fact_order_reviews AS\nSELECT\n    CAST(r.review_id AS VARCHAR(64)) AS review_id,\n    CAST(r.order_id  AS VARCHAR(64)) AS order_id,\n    d.date_sk AS review_date_sk,  -- FK to dim_date\n    \n    r.review_score,\n    r.flag_missing_value\nFROM stg.stg_order_reviews r\nLEFT JOIN dim.dim_date d\n  ON d.[date] = CAST(r.review_answer_timestamp AS DATE); ","type":"Expression"}}],"scriptBlockExecutionTimeout":"02:00:00"}},{"name":"Script_24_fact_orders","type":"Script","dependsOn":[{"activity":"Copy_olist_silver_orders","dependencyConditions":["Succeeded"]},{"activity":"Script_16_dim_date","dependencyConditions":["Succeeded"]},{"activity":"Script_12_dim_customers","dependencyConditions":["Succeeded"]}],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"linkedService":{"name":"Olist_Gold_Warehouse","properties":{"annotations":[],"type":"DataWarehouse","typeProperties":{"endpoint":"syksq5mooojuplq6qvrqwqropy-w4eyqycrmwautdb4wfp7eti4i4.datawarehouse.fabric.microsoft.com","artifactId":"[parameters('Olist_Gold_Warehouse')]","workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47"}}},"typeProperties":{"scripts":[{"type":"Query","text":{"value":"/*\n\nThe stg_orders table contains three flags.\n\n1. flag_missing_value: this is a global missing flag, equal to 1 if any important field is null.\n    The fields are: order_approved_at, order_delivered_carrier_date, and order_delivered_customer_date.\n    There are three flag notes indicating which one is missing and their interpretations.\n\n        1.1. flag_note_order_approved_at: interprets the missing value from order_approved_at \n            - valid - no missing value\n            - plausible - acceptable to be missing, when \"order_status\" is \"canceled\" or \"created\"\n            - anomaly - when \"order_status\" is \"delivered\" but \"order_approved_at\" is null.\n        Decision: keep valid and plausible. Remove anomaly.\n\n        1.2. flag_note_order_delivered_carrier_date: interprets the missing value from order_delivered_carrier_date\n            - valid - no missing value\n            - plausible - acceptable to be missing, when \"order_status\" is \n                        \"canceled\", \"created\", \"processing\", \"invoiced\", \"unavailable\", \"approved\", or \"shipped\"\n            - anomaly - when \"order_status\" is \"delivered\" but \"order_delivered_carrier_date\" is null\n                        or when \"order_delivered_customer_date\" is null and \"order_status\" is \"delivered\".\n        Decision: keep valid and plausible. Remove anomaly.\n\n        1.3. flag_note_order_delivered_customer_date: interprets the missing value from order_delivered_customer_date\n            - valid - no missing value\n            - plausible - acceptable to be missing, when \"order_status\" is \n                        \"canceled\", \"created\", \"processing\", \"invoiced\", \"unavailable\", \"approved\", or \"shipped\"\n            - anomaly - when \"order_status\" is \"delivered\" but \"order_delivered_customer_date\" is null\n                        or when \"order_delivered_customer_date\" is NOT null and \"order_delivered_carrier_date\" is null \n                                                                            and \"order_status\" is \"delivered\".\n        Decision: keep valid and plausible. Remove anomaly.\n\n2. flag_carrier_before_approval: this is a date sanity check.\n    Informs that the order was delivered to the carrier before the payment approval.\n    Decision: remove the flagged rows.\n\n3. flag_customer_before_carrier: this is a date sanity check.\n    Informs that the order was delivered to the customer before being delivered to the carrier\n    Decision: remove the flagged rows.\n\n*/\n\n-- Creating fact_orders\nDROP TABLE IF EXISTS fact.fact_orders;\n\nCREATE TABLE fact.fact_orders AS\nSELECT\n    -- Keys\n    o.order_id,\n    dc.customer_sk,  -- FK to dim_customers\n    dp.date_sk AS purchase_date_sk,  -- FK to dim_date   \n    da.date_sk AS approved_date_sk,\n    dcar.date_sk AS delivered_carrier_date_sk,\n    dcust.date_sk AS delivered_customer_date_sk,\n    dest.date_sk AS estimated_delivery_date_sk,\n\n    -- Source attribute\n    o.order_status,\n \n    -- Calculated metrics\n    DATEDIFF(DAY, o.order_purchase_timestamp, o.order_approved_at) AS days_to_approval,\n    DATEDIFF(DAY, o.order_approved_at, o.order_delivered_carrier_date) AS days_approved_to_carrier,\n    DATEDIFF(DAY, o.order_approved_at, o.order_delivered_customer_date) AS days_approved_to_delivery,\n    DATEDIFF(DAY, o.order_delivered_carrier_date, o.order_delivered_customer_date) AS days_carrier_to_customer,\n\n    CASE \n        WHEN o.order_delivered_customer_date IS NOT NULL\n        THEN DATEDIFF(DAY, o.order_estimated_delivery_date, o.order_delivered_customer_date)\n        ELSE NULL\n    END AS days_late,\n\n    CASE\n        WHEN\n            CASE\n                WHEN o.order_delivered_customer_date IS NOT NULL\n                THEN DATEDIFF(DAY, o.order_estimated_delivery_date, o.order_delivered_customer_date)\n                ELSE NULL\n            END > 0\n        THEN 1 ELSE 0\n    END AS is_late,\n\n    -- Flags\n    o.flag_note_order_approved_at,\n    o.flag_note_order_delivered_carrier_date,\n    o.flag_note_order_delivered_customer_date,\n    o.flag_carrier_before_approval,\n    o.flag_customer_before_carrier \n\nFROM stg.stg_orders o\nLEFT JOIN dim.dim_customers dc ON dc.customer_id = o.customer_id\nLEFT JOIN dim.dim_date dp ON dp.[date] = CAST(o.order_purchase_timestamp AS DATE)\nLEFT JOIN dim.dim_date da ON da.[date] = CAST(o.order_approved_at AS DATE)\nLEFT JOIN dim.dim_date dcar ON dcar.[date] = CAST(o.order_delivered_carrier_date AS DATE)\nLEFT JOIN dim.dim_date dcust ON dcust.[date] = CAST(o.order_delivered_customer_date AS DATE)\nLEFT JOIN dim.dim_date dest ON dest.[date] = CAST(o.order_estimated_delivery_date AS DATE)\nWHERE   o.flag_note_order_approved_at IN ('valid','plausible')\n    AND o.flag_note_order_delivered_carrier_date IN ('valid','plausible')\n    AND o.flag_note_order_delivered_customer_date IN ('valid','plausible')\n    AND COALESCE(o.flag_carrier_before_approval, 0) = 0\n    AND COALESCE(o.flag_customer_before_carrier, 0) = 0; ","type":"Expression"}}],"scriptBlockExecutionTimeout":"02:00:00"}},{"name":"31_dim_order","type":"Script","dependsOn":[{"activity":"Script_24_fact_orders","dependencyConditions":["Succeeded"]},{"activity":"Script_21_fact_order_items","dependencyConditions":["Succeeded"]},{"activity":"Script_22_fact_order_payments","dependencyConditions":["Succeeded"]},{"activity":"Script_23_fact_order_reviews","dependencyConditions":["Succeeded"]}],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"linkedService":{"name":"Olist_Gold_Warehouse","properties":{"annotations":[],"type":"DataWarehouse","typeProperties":{"endpoint":"syksq5mooojuplq6qvrqwqropy-w4eyqycrmwautdb4wfp7eti4i4.datawarehouse.fabric.microsoft.com","artifactId":"[parameters('Olist_Gold_Warehouse')]","workspaceId":"608809b7-6551-4981-8c3c-b15ff24d1c47"}}},"typeProperties":{"scripts":[{"type":"Query","text":{"value":"-- Create dim_order table\nDROP TABLE IF EXISTS dim.dim_order;\n\nCREATE TABLE dim.dim_order AS\nSELECT DISTINCT CAST(order_id AS VARCHAR(64)) AS order_id\nFROM (\n  SELECT order_id FROM fact.fact_orders\n  UNION ALL\n  SELECT order_id FROM fact.fact_order_items\n  UNION ALL\n  SELECT order_id FROM fact.fact_order_payments\n  UNION ALL\n  SELECT order_id FROM fact.fact_order_reviews\n) u;","type":"Expression"}}],"scriptBlockExecutionTimeout":"02:00:00"}}],"lastModifiedByObjectId":"d0c70e26-3249-4e6b-86d6-b1d7d5dc4247","lastPublishTime":"2025-08-25T18:23:46Z"},"dependsOn":[]}]}